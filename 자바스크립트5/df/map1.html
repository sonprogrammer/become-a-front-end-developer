<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>simpleMap</title>
        <script src="https://apis.openapi.sk.com/tmap/js?version=1&format=javascript&appKey=xqY2y0EhCs9wRwlSPyHVM6BaRU8Ggdzq7TAtkmaF"></script>
        <script src="jquery-3.6.4.min.js"></script>
        <script type="text/javascript">
			function initTmap(){
				var map = new Tmap.Map({
					div:'map_div',
					width : "934px",
					height : "452px",
				});
                // map.setCenter(new Tmap.LonLat("126.986072", "37.570028").transform("EPSG:4326", "EPSG:3857"), 15);
                // Tmap.Control를 사용하여 마우스 커서의 현재 위치가 가지는 좌표값을 맵 위에 표시해 주는 컨트롤을 추가해줍니다.  
		map.addControls([
			//마우스 커서의 현재 위치가 가지는 좌표값을 맵 위에 표시해 주는 컨트롤
			//좌표값을 WGS84GEO 좌표계의 값으로 표시해줍니다.
	        new Tmap.Control.MousePosition({displayProjection:"EPSG:4326"})
	    ]);
	    // 지도의 중심점과 zoom레벨 설정
		map.setCenter(new Tmap.LonLat(126.98702028,37.56520450).transform("EPSG:4326", "EPSG:3857"), 17);	
	}
	// 맵 생성 실행
	initTmap();
            

            </script>
            <script>
	var map;
	// 페이지가 로딩이 된 후 호출하는 함수입니다.
	function initTmap(){
		//map 생성
		// Tmap.map을 이용하여, 지도가 들어갈 div, 넓이, 높이를 설정합니다.
	    map = new Tmap.Map({div:'map_div', // map을 표시해줄 div
							width:'100%',  // map의 width 설정
							height:'100%' // map의 height 설정
		}); 
		// 지도의 중심점과 zoom레벨 설정
		map.setCenter(new Tmap.LonLat(126.98702028,37.56520450).transform("EPSG:4326", "EPSG:3857"), 17);
		
		//map 클릭 이벤트 등록 	                    
		map.events.register("click", map, onClick);
	}     
	// 지도를 클릭했을때 발생하는 이벤트 함수입니다.
	function onClick(e){
	  var lonlat = map.getLonLatFromViewPortPx(e.xy).transform("EPSG:3857", "EPSG:4326");//클릭한 부분의 ViewPorPx를 LonLat로 변환합니다
	  var result ='클릭한 위치의 좌표는'+lonlat+'입니다.'; 
	  var resultDiv = document.getElementById("result");
	  resultDiv.innerHTML = result;
	}
	// 맵 생성 실행
	initTmap();
</script>
<p id="result"></p>
            <script>

    // 1. 지도 띄우기
    map = new Tmap.Map({
        div : 'map_div',
        width : "100%",
        height : "400px",
    });
    map.setCenter(new Tmap.LonLat("126.986072", "37.570028").transform("EPSG:4326", "EPSG:3857"), 15);
    //현재위치의 바로 이전위치를 그릴 레이어 생성
    beforeMarkerLayer = new Tmap.Layer.Markers();
    //현재위치를 그릴 레이어 생성
    markerLayer = new Tmap.Layer.Markers();




    // 좌표 표시
    // Tmap.Control를 사용하여 마우스 커서의 현재 위치가 가지는 좌표값을 맵 위에 표시해 주는 컨트롤을 추가해줍니다.  
		map.addControls([
			//마우스 커서의 현재 위치가 가지는 좌표값을 맵 위에 표시해 주는 컨트롤
			//좌표값을 WGS84GEO 좌표계의 값으로 표시해줍니다.
	        new Tmap.Control.MousePosition({displayProjection:"EPSG:4326"})
	    ]);
	    // 지도의 중심점과 zoom레벨 설정
		map.setCenter(new Tmap.LonLat(126.98702028,37.56520450).transform("EPSG:4326", "EPSG:3857"), 17);	
	
	// 맵 생성 실행
	initTmap();
    
    
        // 2. 위치 조회
        if(window.XMLHttpRequest){
               xhttp=new XMLHttpRequest();
           }else{
               xhttp=new ActiveXObject("Microsoft.XMLDOM");
           }
        
        xhttp.open("GET","/web/usecase/sample.kml",true);
        xhttp.send();
        var prtcl =  xhttp.responseXML;
    
        var markerLayer = new Tmap.Layer.Markers();
        var beforeMarkerLayer = new Tmap.Layer.Markers();
        map.addLayer(beforeMarkerLayer);
        map.addLayer(markerLayer);
        var size = new Tmap.Size(24, 38);
        var offset = new Tmap.Pixel(-(size.w / 2), -(size.h));
        var maker;
        var beforeMarker;
        var popup,popup2;
        var beforePopup,beforePopup2;
        var prtclString = new XMLSerializer().serializeToString(prtcl);//xml to String	
        xmlDoc = $.parseXML( prtclString ),
        $xml = $( xmlDoc ),
        $intRate = $xml.find("Placemark");
        
        function myFunction(cnt, checkLevel){
                $intRate.each(function(index, element) {
                    var name = element.getElementsByTagName("name")[0].childNodes[0].nodeValue;
                    var number = element.getElementsByTagName("number")[0].childNodes[0].nodeValue;
                    var affiliation = element.getElementsByTagName("affiliation")[0].childNodes[0].nodeValue;
                    var distance = element.getElementsByTagName("distance")[cnt].childNodes[0].nodeValue;
                    var speed = element.getElementsByTagName("speed")[cnt].childNodes[0].nodeValue;
                    // var content = 
                    //             '<div class="wrap">' + 
                    //             '    <div class="info">' + 
                    //             '        <div class="title">' + 
                    //             '            '+name + 
                    //             '        </div>' + 
                    //             '        <div class="body">' + 
                    //             '            <div class="desc">' + 
                    //             '                <div><span>차량번호</span> '+number+'</div>' +  
                    //             '                <div><span>소속지사</span> '+affiliation+'</div>' + 
                    //             '                <div><span>운행거리</span> '+distance+'km</div>' + 
                    //             '                <div><span>현재속도</span> '+speed+'km/h</div>' + 
                    //             '            </div>' + 
                    //             '        </div>' + 
                    //             '    </div>' +     
                    //             '</div>';
                                
                    //현재위치 바로 이전 위치를 그리기 위한 부분
                    if(cnt > 0 && cnt >= 1 && cnt < 42 && checkLevel != 4){
                        //현재위치 갱신후 이전위치에 있던 마커 삭제
                        markerLayer.clearMarkers();
                        
                        var beforePoint = element.getElementsByTagName("coordinates")[cnt-1].childNodes[0].nodeValue.split(',');
                        var beforeIcon = new Tmap.Icon('icon.png',size, offset);
                        var beforeLonlat = new Tmap.LonLat(beforePoint[0],beforePoint[1]).transform("EPSG:4326", "EPSG:3857");
                        beforeMarker = new Tmap.Marker(beforeLonlat, beforeIcon);
                        
                        beforeMarkerLayer.addMarker(beforeMarker);
                        
                        beforePopup = new Tmap.Popup("p1", beforeLonlat, new Tmap.Size(130, 130), content, true);//마우스 오버 팝업
                        beforePopup2 = new Tmap.Popup("p2", beforeLonlat, new Tmap.Size(130, 130), content, true);//마우스 클릭 팝업
                        map.addPopup(beforePopup);
                        map.addPopup(beforePopup2);
                        beforePopup.hide();
                        beforePopup2.hide();
                        //마커 이벤트등록
                        beforeMarker.events.register("mouseover", beforePopup, onOverMarker);
                        function onOverMarker(evt) {
                            this.show(); //마커에 마우스가 오버되었을 때 팝업이 보입니다. 
                        }
                        beforeMarker.events.register("mouseout", beforePopup, onOutMarker);
                        function onOutMarker(evt) {
                            this.hide(); //마커에 마우스가 없을땐 팝업이 숨겨집니다.
                        }
                        beforeMarker.events.register("click", beforePopup2, onClickMarker);
                        function onClickMarker(evt) {
                            this.show(); //마커에 마우스가 클릭되었을 때 팝업이 보입니다. 
                        }
                    }
                    
                    var point = element.getElementsByTagName("coordinates")[cnt].childNodes[0].nodeValue.split(',');
                    console.log(point[0]+","+point[1]);
                    var icon = new Tmap.Icon('icon.png',size, offset);
                    var lonlat = new Tmap.LonLat(point[0],point[1]);
                    console.log(lonlat.toShortString());
                    marker = new Tmap.Marker(lonlat, icon);
                    markerLayer.addMarker(marker);
                    
                    popup = new Tmap.Popup("p1", lonlat, new Tmap.Size(130, 130), content, true);//마우스 오버 팝업
                    popup2 = new Tmap.Popup("p2", lonlat, new Tmap.Size(130, 130), content, true);//마우스 클릭 팝업
                    map.addPopup(popup);
                    map.addPopup(popup2);
                    popup.hide();
                    popup2.hide();
                    //마커 이벤트등록
                    marker.events.register("mouseover", popup, onOverMarker);
                    function onOverMarker(evt) {
                      this.show(); //마커에 마우스가 오버되었을 때 팝업이 보입니다. 
                    }
                    marker.events.register("mouseout", popup, onOutMarker);
                    function onOutMarker(evt) {
                      this.hide(); //마커에 마우스가 없을땐 팝업이 숨겨집니다.
                    }
                    marker.events.register("click", popup2, onClickMarker);
                    function onClickMarker(evt) {
                        this.show(); //마커에 마우스가 클릭되었을 때 팝업이 보입니다. 
                    }
                });
            }
            myFunction(0);
        
    
        // 3. 위치 관제 시작
        var cnt = 1;
        myVar = setInterval(function(){
            var count = $xml.find("Placemark")[0].getElementsByTagName("coordinates").length;
            if(cnt == count){
                cnt = 0;
                //리셋
                markerLayer.clearMarkers();
                beforeMarkerLayer.clearMarkers();
            }
            myFunction(cnt);
            cnt++;
        }, 1000);
        
    
        // // 4. 위치 관제 종료
        // clearTimeout(myVar);
        // markerLayer.clearMarkers();
        // beforeMarkerLayer.clearMarkers();
        // var lastIndex = $intRate.find("coordinates").length-1
        // myFunction(lastIndex,checkLevel);
        
        // var result ='총 거리 : 4.412km 총 소요시간 : 22분 '; 
        // var resultDiv = document.getElementById("result");
        // resultDiv.innerHTML = result;
        
    </script>	
                    
    
                
    
			

    </head>
    <body onload="initTmap()">
        <div id="map_div">
        </div>        
    </body>
</html>	