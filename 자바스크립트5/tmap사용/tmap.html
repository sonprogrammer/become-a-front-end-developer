<html>
    <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
            <title>tMap</title>
            <script
                src="https://apis.openapi.sk.com/tmap/js?version=1&format=javascript&appKey=xqY2y0EhCs9wRwlSPyHVM6BaRU8Ggdzq7TAtkmaF"></script>
            <script src="jquery-3.6.4.min.js"></script>
           

            <!-- <p id="location">위치 정보를 불러오는 중...</p> -->
            <script>

                // let markerList = []
                // let beforeMarkerList = []

                //페이지가 로딩이 된 후 호출하는 함수입니다
                let map,
                    marker,
                    markerLayer;
                function initTmap() {
                    //map 생성, Tmap.map을 이용하여, 지도가들어갈 div, 넓이, 높이를 설정합니다.
                    map = new Tmap.Map({div: 'map_div',
                    width: "100%",
                    height: "100%"});
                    
                    // center : new Tmapv2.LatLng(126.986072, 37.570028),
                    // map.setZoom(15)


                    
                    if (navigator.geolocation) {
                        //GeoLocation을 이용해 접속 위치 얻어옴
                        navigator
                            .geolocation
                            .getCurrentPosition(position => {
                                //마커가 표시될 위치를 geolocation으로 얻어온 좌표로 생성
                                let lat = position.coords.latitude
                                let lon = position.coords.longitude
                                let PR_3857 = new Tmap.Projection("EPSG:3857") //google mercator 좌표계인 EPSG:3857
                                let PR_4326 = new Tmap.Projection("EPSG:4326") //WGS84 좌표계인 EPSG:4326
                                let lonlat = new Tmap
                                    .LonLat(lon, lat)
                                    .transform(PR_4326, PR_3857)
                                let size = new Tmap.Size(24, 38)
                                let offset = new Tmap.Pixel(-(size.w / 2), -(size.h))
                                let icon = new Tmap.Icon('icon1.png', size, offset)

                                marker = new Tmap.Marker(lonlat, icon); //마커 생성
                                markerLayer.addMarker(marker); //레이어에 마커 추가

                                //팝업 생성
                                // let popup
                                // let content = "<div style=' position: relative; border-bottom: 1px solid #dcdcdc; line-height" +
                                //         ": 18px; padding: 0 35px 2px 0;'><div style='font-size: 12px; line-height: 15px" +
                                //         ";'><span style='display: inline-block; width: 14px; height: 14px; background-i" +
                                //         "mage: url(/resources/images/common/icon_blet.png); vertical-align: middle; mar" +
                                //         "gin-right: 5px;'></span>myLocation</div></div>";
                                // popup = new Tmap.Popup("p1", lonlat, new Tmap.Size(155, 50), content, onPopupClose)
                                // popup.setBorder("1px solid #8d8d8d")    //popup border 조절
                                // popup.autoSize = true   //popup 사이즈 자동 조절
                                // map.addPopup(popup) //지도에 팝업을 추가해준다
                                // popup.show()    //팝업을 보여준다
                                map.setCenter(lonlat)   //geolocation으로 얻어온 좌표로 지도의 중심을 설정한다
                                //팝업창을 닫을 수 있는 이벤트 함수
                                // function onPopupClose(){
                                //     select.unselectAll()
                                // }

                            });
                    }

                    //마커 생성
                    markerLayer = new Tmap.Layer.Markers()
                    // let markers = new Tmap
                    //     .Layer
                    //     .Markers('MarkerLayer'); //마커 레이어 생성
                    let lonlat = new Tmap
                        .LonLat(126.986072, 37.570028)
                        .transform("EPSG:4326", "EPSG:3857"); //좌표 설정
                    map.addLayer(markerLayer); //map에 마커 레이어 추가
                    map.setCenter(lonlat,17)    //map 중심 좌표 설정

                    let size = new Tmap.Size(24, 38); //아이콘 크기 설정
                    let offset = new Tmap.Pixel(-(size.w / 2), -(size.h)); //아이콘 중심점 설정
                    let icon = new Tmap.Icon(
                        // 'icon.png',
                        'icon1.png',
                        size,
                        offset
                    ); //마커 아이콘 설정
                    

                    // let marker = new Tmap.Marker(lonlat, icon); //마커 생성
                    // markers.addMarker(marker); //레이어에 마커 추가

                    //현재 위치 정보 받아오기
                    

                    //  위치 정보를 이용하여 지도에 마커 표시 또는 지도 중심 이동 등을 수행할 수 있습니다. map 클릭 이벤트 등록
                    map
                        .events
                        .register("click", map, onClick);
                    // map.setCenter(new Tmap.LonLat("126.986072",
                    // "37.570028").transform("EPSG:4326", "EPSG:3857"), 15); Tmap.Control를 사용하여 마우스
                    // 커서의 현재 위치가 가지는 좌표값을 맵 위에 표시해 주는 컨트롤을 추가해줍니다.
                    map.addControls([
                        // 마우스 커서의 현재 위치가 가지는 좌표값을 맵 위에 표시해 주는 컨트롤 좌표값을 WGS84GEO 좌표계의 값으로 표시해줍니다. new
                        Tmap
                            .Control
                            .MousePosition({displayProjection: "EPSG:4326"})
                    ]);

                }

                //지도를 클릭했을때 발생하는 이벤트 함수입니다.
                function onClick(e) {
                    let lonlat = map
                        .getLonLatFromViewPortPx(e.xy)
                        .transform("EPSG:3857", "EPSG:4326"); //클릭한 부분의 ViewPorPx를 LonLat로 변환합니다
                    let result = '클릭한 위치 좌표는' + lonlat + '입니다.';
                    let resultDiv = document.getElementById("result");
                    resultDiv.innerHTML = result;
                }

                /*
                // 위치관제 지도띄우기 step1

                // 현재 위치의 바로 이전위치를 그릴 레이어 생성
                let beforeMarkerLayer = new Tmap.Layer.Markers()    
                //현재 위치를 그릴 레이어 생성
                let markerLayer = new Tmap.Layer.Markers()

                //위치 조회
                if(window.XMLHttpRequest){
                    xhhtp = new XMLHttpRequest()
                }else{
                    xhttp = new ActiveXObject("Microsoft.XMLDOM")
                }

                xhttp.open("GET", "/web/usecase/sample.kml", false)
                xhttp.send()
                let prtcl = xhhtp.responseXML

                let markerLayer = new Tmap.Layer.Markers()
                map.addLayer(beforeMarkerLayer)
                map.addLayer(markerLayer)
                let size = new Tmap.Size(24, 38)
                let offset = new Tmap.Pixel(-(size.w / 2), -(size.h))
                let maker //수상함ㅎㅎ
                let beforeMarker
                let popup, popup2
                let beforePopup, beforePopup2
                let prtclString = new XMLSerializer().serializeToString(prtcl)  //xml -> string
                xmlDoc = $.parseXML( prtclString),
                $xml = $(xmlDoc),
                $intRate = $xml.find("Placemark")

                function myFunction(cnt, checkLevel){
                    $intRate.each(function(index, element){
                        let name = element.getElementsByTagName("name")[0].childNodes[0].nodeValue
                        let number = element.getElementsByTagName("number")[0].childNodes.nodeValue
                        let affiliation = element.getElementsByTagName("affiliation")[0].childNodes.nodeValue
                        let distance = element.getElementsByTagName("distance")[0].childNodes.nodeValue
                        let speed = element.getElementsByTagName("speed")[0].childNodes.nodeValue
                        let content = 
                        '<div class="wrap">' + 
			                '    <div class="info">' + 
			                '        <div class="title">' + 
			                '            '+name + 
			                '        </div>' + 
			                '        <div class="body">' + 
			                '            <div class="desc">' + 
			                '                <div><span>차량번호</span> '+number+'</div>' +  
			                '                <div><span>소속지사</span> '+affiliation+'</div>' + 
			                '                <div><span>운행거리</span> '+distance+'km</div>' + 
                            '                <div><span>현재속도</span> '+speed+'km/h</div>' + 
			                '            </div>' + 
			                '        </div>' + 
			                '    </div>' +     
                            '</div>';
                        //현재 위치 바로 이전 위치를 그리기 위한 부분
                        if(cnt > 0 && cnt >= 1 &&cnt < 42 && checkLevel != 4){
                            //현재위치 갱신 후 이전 위치에 있던 마커 삭제
                            markerLayer.clearMarkers()

                            let beforePoint = element.getElementsByTagName("coordinates")[cnt -1].childNodes[0].nodeValue.split(',')
                            let beforeIcon = new Tmap.Icon('/resources/images/common/before_car.png', size, offset)
                            let beforeLonlat = new Tmap.LonLat(beforePoint[0],beforePoint[1].transform("EPSG:4326", "EPSG:3857"))
                            beforeMarker = new Tmap.Marker(beforeLonlat, beforeIcon)

                            beforeMarkerLayer.addMarker(beforeMarker)

                            beforePopup = new Tmap.Popup("p1", beforeLonlat, new Tmap.Size(130, 130), content, true)   //마우스 오버 팝업
                            beforePopup2 = new Tmap.Popup("p2", beforeLonlat, new Tmap.Size(130, 130), content, true)   //마우스 클릭 팝업
                            map.addPopup(beforePopup)
                            map.addPopup(beforePopup2)
                            beforePopup.hide()
                            beforePopup2.hide()

                            //마커 이벤트 등록
                            beforeMarker.events.register("mouseover", beforePopup, onOutMarker)
                            function onOutMarker(evt){
                                this.hide() //마커에 마우스가 없을 땐 팝업이 숨겨진다
                            }
                            beforeMarker.events.register("click", beforePopup2, onClickMarker)
                            function onClickMarker(evt){
                                this.show() //마커에 마우스가 클릭되었을 때 팝업이 보인다
                            }
                        }
                                //복붙시작
                                var point = element.getElementsByTagName("coordinates")[cnt].childNodes[0].nodeValue.split(',');
				console.log(point[0]+","+point[1]);
				var icon = new Tmap.Icon('/resources/images/common/pin_car.png',size, offset);
				var lonlat = new Tmap.LonLat(point[0],point[1]);
				console.log(lonlat.toShortString());
				marker = new Tmap.Marker(lonlat, icon);
				markerLayer.addMarker(marker);
				
				popup = new Tmap.Popup("p1", lonlat, new Tmap.Size(130, 130), content, true);//마우스 오버 팝업
				popup2 = new Tmap.Popup("p2", lonlat, new Tmap.Size(130, 130), content, true);//마우스 클릭 팝업
				map.addPopup(popup);
				map.addPopup(popup2);
				popup.hide();
				popup2.hide();
				//마커 이벤트등록
			    marker.events.register("mouseover", popup, onOverMarker);
			    function onOverMarker(evt) {
			      this.show(); //마커에 마우스가 오버되었을 때 팝업이 보입니다. 
			    }
			    marker.events.register("mouseout", popup, onOutMarker);
			    function onOutMarker(evt) {
			      this.hide(); //마커에 마우스가 없을땐 팝업이 숨겨집니다.
			    }
			    marker.events.register("click", popup2, onClickMarker);
			    function onClickMarker(evt) {
			    	this.show(); //마커에 마우스가 클릭되었을 때 팝업이 보입니다. 
				}
		    });
	    }
		myFunction(0);
	
	
				

		*/


            </script>
            <p id="result"></p>
            <!-- 마커 생성 -->

            
            <script>

                // let markerList = []; let beforeMarkerList = []; map = new
                // Tmapv2.Map("map_div", {     center: new Tmapv2.LatLng(),     width: "100%",
                // height: "100%" }); map.setZoom(15); 현재위치의 바로 이전위치를 그릴 레이어 생성
                // beforeMarkerLayer = new Tmap .Layer     .Markers(); 현재위치를 그릴 레이어 생성
                // markerLayer = new Tmap     .Layer .Markers(); 좌표 표시 Tmap.Control를 사용하여 마우스
                // 커서의 현재 위치가 가지는 좌표값을 맵 위에 표시해 주는 컨트롤을 추가해줍니다. map.addControls([     마우스 커서의 현재
                // 위치가 가지는 좌표값을 맵 위에 표시해 주는 컨트롤 좌표값을 WGS84GEO 좌표계의 값으로 표시해줍니다.     new Tmap
                // .Control .MousePosition({displayProjection: "EPSG:4326"}) ]); 지도의 중심점과 zoom레벨
                // 설정 map.setCenter(     new Tmap.LonLat(126.98702028,
                // 37.56520450).transform("EPSG:4326", "EPSG:3857"), 17 ); 맵 생성 실행 initTmap();
            </script>

        </head>
        <body>
            <body onload="initTmap()">
                <div id="map_div"></div>

            </body>
        </html>